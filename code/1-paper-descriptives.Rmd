---
title: "1-paper-descriptives"
author: "Johh-Henry Pezzuto"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  rmarkdown::html_document:
    smart: true
    theme: spacelab
    number_sections: no
    toc_float:
      collapsed: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

This document reproduces every quatntitative claim and figure in all of the paper's sections up to the meta-analysis itself.

**knitr options, libraries, and load data**
```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE, 
                      results = 'markup')

library(dplyr, warn.conflicts = F)
library(forcats)
library(ggrepel)
library(ggtext)
library(ggthemes)
library(janitor)
library(kableExtra)
library(knitr) 
library(patchwork)
library(scales)
library(stringr)
library(tidyr, quietly = T)

dat <- readRDS(file = '../data/sv_meta_data.rds')
```

# introduction

Slightly fewer than half (140 of 298) of the studies that we identified for our quantitative meta-analysis measured rape myths in some form

```{r rape_myth_measurement}
dat %>%
  group_by(unique_study_id) %>%
  summarize(has_myth_or_IRMA = any(str_detect(scale_name, "myth|irma|illinois"))) %>%
  count(has_myth_or_IRMA)

```

## The Problem of Sexual Violence

(The PRISMA Flow Diagram (Appendix Figure \ref{fig:prisma}) explains how we winnowed the original pool of studies down to the 225 manuscripts)

```{r num_unique_papers}
range(dat$unique_paper_id)

```

Our present review provides empirical results from 13 countries

```{r unique_countries}
length(unique(dat$country))
```

## Inclusion and Exclusion Criteria for Study Selection

Table $\ref{tab:n_designs}$ details the number of papers for each study design.
```{r table_one}
dat |> 
  distinct(unique_paper_id, unique_study_id, study_design) |> 
  group_by(study_design) |> 
  summarise(n_papers = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id)) |> 
  kable(format = "latex", booktabs = T)
```


## Overview of the Studies in the Meta-Analytic Database

The database spans the years 1985-2018, encompassing 225 manuscripts that describe 298 studies, in which we coded 409 distinct point estimates.

```{r years_and_countries}
dat |> 
  summarise(year_min = min(year),
            year_max = max(year),
            n_manuscripts = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id),
            n_point_estimates = n())
```


Overall these are relatively large studies, with an average of 403 participants and a median of 162 participants. 
```{r avg_study_size}
dat |> 
  group_by(unique_study_id) |> 
  summarise(mean_n_per_study = mean(n_t_post, na.rm = T) + mean(n_c_post, na.rm = T)) |>  # collapse outcomes first, so studies with more outcomes don't have more weight
  ungroup() |> 
  summarise(mean_n = mean(mean_n_per_study), # then collapse studies in estimate
            median_n = median(mean_n_per_study))
```


In addition, 30% percent of these studies test primary prevention efforts that span more than one day.

```{r perc_greater_1_day}
dat |>
  distinct(unique_study_id, intervention_length) |> 
  mutate(intervention_length = ifelse(intervention_length > 1, 1, 0)) |> 
  summarise(perc_greater_1_day = mean(intervention_length, na.rm = T))
```


Over these years, we observed an uneven rise in the study of primary prevention efforts. This rise is depicted in \textbf{Figure \ref{fig:tt_studies}}. 

```{r studies_over_time}
tt_overall = dat |> # overall line
      group_by(year) |>
      summarise(n = n_distinct(unique_study_id)) |>
      add_row(year = 1985, n = 0)

zeitgeist = tibble(year = c(1998, 2000, 2007), 
                   n = pull(filter(tt_overall, year %in% c(1998, 2000, 2007)), n),
                   event = c("Safe dates", "Men's Program", "Bringing in\nthe Bystander"))

tt_overall     |>
  ggplot(aes(year, n)) +
  geom_line(linewidth = 2) +
    geom_label_repel(mapping = aes(x = year, ## labels
                                   y = n,
                                   label = event),
                     size = 6,
                     segment.size	= 1.5,
                     inherit.aes = F,
                     data =  zeitgeist,
                     nudge_x = c(2, 2.5, -1.9),
                     nudge_y = c(6, 5.5, 5),
                     min.segment.length = 0, 
                     force = 0.3) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.position = "bottom"
  ) +
  labs(
    x = NULL,
    y = "# of studies",
    col = NULL
  )

ggsave("../results/figures/tt_studies.pdf", height = 5, width = 7.5)
```

We observe that 265 studies which constitute 89% of the database were conducted in the United States. The remaining 33 studies come from various places around the world, including Canada, Europe, and Africa.

```{r country_distribution}
dat |> 
  distinct(unique_study_id, country) |> 
  count(country, sort = T) |> 
  mutate(perc = round(n / sum(n), 3))
```

Nearly 69% of all studies are conducted among college students. Another 13% focus on high school students, while 9% percent focus on middle school students. Outside of the education sphere, we find that 4% of studies were conducted in the workplace, and 2% in community settings. 

```{r study_settings}
dat |> 
  distinct(unique_study_id, setting) |> 
  count(setting, sort = T) |> 
  mutate(perc = round(n / sum(n), 3))
```

In fact, 67% of the studies targeted both men and women, while 27% targeted only men, and 6% targeted only women (1% of studies did not report the gender target).

```{r gender_breakdown}
dat |> # 
  mutate(participant_sex = 
           ifelse(participant_sex %in% c("male and female in mixed groups", 
                                         "male and female in separate groups and also in combined groups",
                                          "male and female in separate groups",
                                         "male and female with group composition not specified",
                                         "general population"),
                  "mixed gender groups", 
                  participant_sex)) |>
  distinct(unique_study_id, participant_sex) |>
  count(participant_sex, sort = T) |> 
  mutate(perc = round(n / sum(n), 3))
```


```{r descriptive_fig}
(country_fig = dat |> 
  distinct(unique_study_id, country) |> 
  mutate(country = ifelse(country == "USA", "USA", "Rest of the world")) |> 
  count(country, sort = T) |> 
  mutate(country = fct_rev(fct_reorder(factor(country), n)),
         perc = n / sum(n)) |>
  ggplot(aes(country, n, label = n, fill = country)) +
  geom_col() +
  theme_bw() +
  theme(axis.text = element_markdown(size = 12), 
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        plot.title = element_markdown()) +
  scale_y_continuous(breaks = seq(0, 300, by = 100), limits = c(0, 300)) +
  scale_fill_manual(values = ggthemes::solarized_pal()(2)) +
  guides(fill = "none") +
  labs(title = "**a)** Number of Studies by Country",
       x = NULL, 
       y = "# of studies", 
       col = NULL))
  
(setting_fig = dat |> 
  distinct(unique_study_id, .keep_all = T) |> 
  count(setting, sort = T) |> 
  drop_na(setting) |> 
  mutate(setting = fct_rev(fct_reorder(setting, n)), 
         perc = n / sum(n)) |>
  ggplot(aes(setting, n, fill = setting)) +
  geom_col() +
  scale_fill_manual(values = ggthemes::tableau_color_pal('Tableau 10')(6)) +
  labs(title = "**b)** Number of Studies by Setting",
       x = NULL, 
       y = "# of studies", 
       col = NULL) +
  theme_bw() +
    guides(fill = "none") +
  theme(axis.text = element_markdown(size = 12),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        plot.title = element_markdown()))


dat_participant_sex <- dat |> # participant sex lines
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", 
                                         "male and female in separate groups and also in combined groups",
                                          "male and female in separate groups",
                                         "male and female with group composition not specified",
                                         "general population"), 
                                      "mixed gender groups", 
                                      participant_sex)) |>
      distinct(unique_study_id, .keep_all = T) |>
      filter(participant_sex %in% c("mixed gender groups", "only male", "only female")) |>
      count(year, participant_sex) |>
      add_row(year = 1985, participant_sex = "mixed gender groups") |>
      complete(year, participant_sex, fill = list(n = 0)) |>
      mutate(participant_sex = str_to_title(participant_sex)) |>
  mutate(participant_sex = factor(participant_sex, levels = c("Mixed Gender Groups", "Only Male", "Only Female")))

(tt_gender_fig = dat_participant_sex |>
  ggplot(aes(year, n, col = participant_sex)) +
  geom_line(linewidth = 2) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::palette_pander(3)) +
  theme_bw() +
  theme(
    axis.text = element_markdown(size = 12), 
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    plot.title = element_markdown(),
    legend.position = "bottom"
  ) +
  labs(
    title = "**c)** Number of Studies Over Time by Group Gender (1985-2018)",
    x = NULL,
    y = "# of studies",
    col = NULL
  ))

country_fig / setting_fig / tt_gender_fig

ggsave("../results/figures/descriptive.pdf", width = 7, height = 7)
```


# Zeitgeist Programs

### The first decadex

 In the first 10 years, we find 47 studies reported in 33 manuscripts
 
```{r early_years_study_count}
dat |> 
  filter(between(year, 1985, 1995)) |> 
  summarise(n_manuscript = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id))
dat |> 
  mutate(early = between(year, 1985, 1995)) |> 
  distinct(unique_study_id, .keep_all = T) |> 
  summarise(perc_early = mean(early))
```

This is also apparent when looking at the type of publication; while 24 of these studies are journal articles, 23 are dissertations

```{r early_years_published_dissertation_breakdown}
dat |> 
  filter(between(year, 1985, 1995)) |> 
  distinct(unique_study_id, publication_type) |> 
  count(publication_type)
```


The majority of these studies are laboratory studies (n = 27) as opposed to field studies (n = 20) that encompass the larger programmatic evaluations that dominate the next generation of studies.

```{r early_years_lab_field} 
dat |> 
  filter(between(year, 1985, 1995)) |> 
  distinct(unique_study_id, lab_field, publication_type) |> 
  count(lab_field)
```

These studies tend to be smaller than the next generation of studies (with an average of 191 participants)

```{r early_years_study_size}
dat |> 
  filter(between(year, 1985, 1995)) |> 
  group_by(unique_study_id) |> 
  summarise(mean_n_per_study = mean(n_t_post, na.rm = T) + mean(n_c_post, na.rm = T)) |>  # collapse outcomes first, so studies with more outcomes don't have more weight
  ungroup() |> 
  summarise(mean_n = mean(mean_n_per_study)) # then collapse studies in estimate
```

They target both men and women (33 studies, which constitute 67\% of all studies in this time frame), but a relatively high number of studies target only men (11 studies, or 22\% of all studies in this time frame). 

```{r early_years_gender_breakdown}
dat |> 
  filter(between(year, 1985, 1995)) |> 
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", 
                                         "male and female in separate groups and also in combined groups",
                                          "male and female in separate groups",
                                         "male and female with group composition not specified",
                                         "general population"), 
                                      "mixed gender groups", 
                                      participant_sex)) |>
      distinct(unique_study_id, participant_sex) |>
  count(participant_sex, sort = T) |> 
  mutate(perc = n / sum(n))
```

## Trends in Measurement in the Database

outcomes referring to an individual's ideas about sexual violence outnumber behavioral outcomes in our sample by 354 to 145. 

```{r ideas_vs_behavior_outcome_count}
dat |> 
  select(scale_type) |> 
  group_by(scale_type) |> 
  summarise(n = n())
```


202 measure outcomes about ideas only
```{r att_only}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_ideas = sum(scale_type == "ideas") / n()) |> 
  filter(perc_ideas == 1) |> 
  ungroup() |> 
  nrow()
```


36 measure only behaviors; 
```{r behaviors_only}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_ideas = sum(scale_type == "ideas") / n()) |> 
  filter(perc_ideas == 0) |> 
  ungroup() |> 
  nrow()
```


62 measure both
```{r}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_ideas = sum(scale_type == "ideas") / n()) |> 
  filter(!perc_ideas %in% c(0,1)) |> 
  ungroup() |> 
  nrow()
```


While in the first 15 years, the ratio between ideas-based outcomes and behavior outcomes was 1:4.75, 
```{r early_years_ratio_between_ideas_and_beahvior_outcomes}
dat |> 
  filter(between(year, 1985, 2000)) |>
  count(scale_type) |> 
  pivot_wider(names_from = scale_type, values_from = n) |> 
  mutate(ratio = ideas/behavior)
```

after 2010 this ratio drops to 1:1.35. 
```{r post_2010_ratio_ideas_behavvior}
dat |> 
  filter(year > 2010) |>
  count(scale_type) |> 
  pivot_wider(names_from = scale_type, values_from = n) |> 
  mutate(ratio = ideas/behavior)
```


Fig 3 displays the relationship between these outcomes over time.

```{r fig_tt_att_beh}
dat |> 
  mutate(scale_type = str_to_title(ifelse(scale_type == "ideas", "ideas", "behavior"))) |> 
  distinct(year, unique_study_id, scale_type) |> 
  count(year, scale_type) |> 
  add_row(year = 1985, scale_type = "Behavior") |> 
  complete(year, scale_type, fill = list(n = 0)) |> 
  ggplot(aes(x = year, y = n, color = scale_type)) +
  geom_line(linewidth = 3) + 
  labs(
    x = NULL,
    y = "# of studies",
    col = NULL
  ) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::tableau_color_pal('Color Blind')(2)) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12), 
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.position = "bottom"
  )

ggsave("../results/figures/tt_att_beh.pdf", height = 5)
```


## Measuring Sexually Violent Behavior

behavioral outcomes that fall into four categories: perpetration, victimization, bystander, and involvement. Figure $\ref{fig:tt_att_beh}$ demonstrates the trends over time in these measurements.

```{r behavioral_outcomes_by_decade}
dat |>
  filter(behavior_type != "ideas") |> 
  distinct(unique_study_id, decade, behavior_type) |> 
  count(decade, behavior_type) |> 
  complete(decade, behavior_type, fill = list(n = 0)) |> 
  ggplot(aes(x = decade, y = n, color = behavior_type, group = behavior_type)) +
  geom_line(linewidth = 3) + 
  labs(x = NULL, 
       y = "# of studies", 
       col = NULL) +
  # scale_x_continuous(
  #   limits = c(1985, 2018),
  #   breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  # ) +
  scale_color_manual(values = ggthemes::stata_pal("s1color")(4)) +
  theme_bw() +
    theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),    
    legend.position = "bottom",
    legend.box = "vertical"
  )

ggsave("../results/figures/tt_beh_type.pdf")
```


## Measuring ideas

Overall these and other myth measures constitute 56% of the measures we coded that assessed ideas about sexual violence
```{r myth_percentage}
dat |> 
  select(scale_name, behavior_type) |> 
  filter(behavior_type == "ideas") |> 
  mutate(myth_scale = str_detect(str_to_lower(scale_name), "myth")) |> 
  group_by(myth_scale) |> 
  summarise(n = n()) |> 
  mutate(perc = n / sum(n))
```
