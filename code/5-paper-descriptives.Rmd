---
title: "5-descriptives"
author: "Seth Green and Johh-Henry Pezzuto"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  rmarkdown::html_document:
    smart: true
    theme: spacelab
    number_sections: no
    toc_float:
      collapsed: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE, 
                      results = 'markup')


library(tidyverse)
library(ggtext)
library(patchwork)
library(ggthemes)
library(ggrepel)
library(knitr) 
library(kableExtra)
library(janitor)
library(metafor)

dat_something <- readRDS(file = '../data/sa_meta_data_for_analysis.rds') %>%
  mutate(
    attitudes_behaviors = case_when(
      all(c('attitudes', 'behavior') %in% scale_type) ~ 0,
      scale_type == 'attitudes' ~ 1,
      scale_type == 'behavior' ~ 2)) %>%
  ungroup() %>% 
  mutate(study_design = case_when(study_design == "pre-post" ~ "Observational",
                                  study_design == "rct" ~ "Randomized Control Trial",
                                  study_design == "quasi-experimental" ~ "Quasi-Experimental"),
         study_design = factor(study_design, levels = c("Randomized Control Trial", 
                                                        "Quasi-Experimental", 
                                                        "Observational")),
         behavior_type = str_to_title(behavior_type))
```

Our present review seeks to summarize all primary prevention efforts over the past X years, from X countries
```{r years_and_countries}
dat |> 
  summarise(year_min = min(year),
            year_max = max(year),
            year_diff = year_max - year_min,
            n_countries = n_distinct(country))


dat |>
  distinct(unique_study_id, intervention_length) |> 
  mutate(intervention_length = ifelse(intervention_length > 1, 1, 0)) |> 
  summarise(perc_greater_1 = mean(intervention_length, na.rm = T))


## outcomes
dat |>
  select(unique_study_id, delay) |> 
  group_by(unique_study_id) |> 
  filter(delay == max(delay)) |> 
  ungroup() |> 
  mutate(delay = ifelse(delay > 0, 1, 0)) |> 
  summarise(perc_greatereql_1 = mean(delay))
```


Most of the studies we identified in the first 15 years were conducted by students coming from various disciplines including psychology, educational psychology, and counseling psychology. The majority of these studies are laboratory studies (n = 107) as opposed to field studies (n = 78) that encompass the larger programmatic evaluations that dominate the next generation of studies.
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_study_id, lab_field, publication_type) |> 
  count(lab_field)


dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_paper_id, author, year, paper_title, lab_field) |> 
  View()
  write_csv("first_15years.csv")

dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_paper_id) |> 
  nrow()


dat |> 
  mutate(early = between(year, 1985, 2000)) |> 
  distinct(unique_paper_id, .keep_all = T) |> 
  summarise(perc_early = mean(early))

dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_study_id, publication_type) |> 
  count(publication_type) |> 
adorn_totals()


dat |> 
  select(scale_name, behavior_type) |> 
  filter(behavior_type == "Attitude") |> 
  mutate(myth_scale = str_detect(str_to_lower(scale_name), "myth")) |> 
  group_by(myth_scale) |> 
  summarise(n = n())
  
```






```{r}
(country_fig = dat |> 
  distinct(unique_study_id, country) |> 
  mutate(country = ifelse(country == "USA", "USA", "Rest of the world")) |> 
  count(country, sort = T) |> 
  mutate(country = fct_rev(fct_reorder(factor(country), n)),
         perc = n / sum(n)) |>
  ggplot(aes(country, n, label = n, fill = country)) +
  geom_col() +
  theme_bw() +
  theme(axis.text = element_markdown(size = 12), 
        plot.title = element_markdown()) +
  scale_y_continuous(breaks = seq(0, 300, by = 100), limits = c(0, 300)) +
   scale_fill_manual(values = ggthemes::solarized_pal()(2)) +
  guides(fill = "none") +
  labs(title = "**a)** Number of Studies by Country",
       x = NULL, 
       y = "# of studies", 
       col = NULL))
  
(setting_fig = dat |> 
  distinct(unique_study_id, .keep_all = T) |> 
  count(setting, sort = T) |> 
  drop_na(setting) |> 
  mutate(perc = n / sum(n)) |>
  ggplot(aes(setting, n, fill = setting)) +
  geom_col() +
  scale_fill_manual(values = ggthemes::tableau_color_pal('Tableau 10')(6)) +
  labs(title = "**b)** Number of Studies by Setting",
       x = NULL, 
       y = "# of studies", 
       col = NULL) +
  theme_bw() +
    guides(fill = "none") +
  theme(axis.text = element_markdown(size = 12),
        plot.title = element_markdown()))

country_fig / setting_fig 

ggsave("results/descriptive.pdf", width = 7, height = 7)
```

```{r}
dat |> 
  distinct(unique_study_id, .keep_all = T) |> 
  count(setting, sort = T) |> 
  mutate(perc = n / sum(n)) |> 
  janitor::adorn_totals()
```

```{r}
dat |> 
  distinct(unique_paper_id, .keep_all = T) |> 
  count(setting, sort = T) |> 
  mutate(perc = n / sum(n)) |> 
  janitor::adorn_totals()
```

```{r}
dat |> 
    mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", "male and female with group composition not specified", "male and female in separate groups"), "mixed gender groups", participant_sex)) |> 
  distinct(unique_paper_id, .keep_all = T) |> 
  count(participant_sex, sort = T) |> 
  mutate(perc = n / sum(n)) |> 
  janitor::adorn_totals()
```

```{r}
dat_participant_sex <-
  bind_rows(
    dat |> # overall line
      group_by(year) |>
      summarise(n = n_distinct(unique_study_id)) |>
      add_row(year = 1985, n = 0) |>
      mutate(participant_sex = "Overall"),
    
    dat |> # participant sex lines
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", "male and female with group composition not specified", "male and female in separate groups"), "mixed gender groups", participant_sex)) |>
      distinct(unique_study_id, .keep_all = T) |>
      filter(participant_sex %in% c("mixed gender groups", "only male", "only female")) |>
      count(year, participant_sex) |>
      add_row(year = 1985, participant_sex = "mixed gender groups") |>
      complete(year, participant_sex, fill = list(n = 0)) |>
      mutate(participant_sex = str_to_title(participant_sex))
  ) |>
  mutate(participant_sex = factor(participant_sex, levels = c("Overall", "Mixed Gender Groups", "Only Male", "Only Female")))

zeitgeist = 
dat_participant_sex |> 
  filter(participant_sex == "Overall", year %in% c(1998, 2000, 2007)) |> 
  mutate(event = c("Safe dates", "Men's Program", "Bringing in\nthe Bystander"))

dat_participant_sex |>
  ggplot(aes(year, n, col = participant_sex)) +
  geom_line(size = 2) +
  geom_segment(aes(x = year, ## add "flag poles"
                   xend = year,
                   y = 0,
                   yend = n,
                   label = NULL),
               inherit.aes = F, 
               linewidth = 1.5,
               data = zeitgeist) +
    geom_label_repel(mapping = aes(x = year, ## labels
                                   y = n,
                                   label = event),
                     size = 6,
                     segment.size	= 1.5,
                     inherit.aes = F,
                     data =  zeitgeist,
                     nudge_x = c(1.5, 2.5, -2),
                     nudge_y = c(6, 5, 5),
                     min.segment.length = 0, 
                     force = 0.3,
                     size = 2) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::palette_pander(4)) +
  #scale_color_manual(values = ggthemes::tableau_color_pal("Color Blind")(4)) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  labs(
    x = NULL,
    y = "# of studies",
    col = NULL
  )

ggsave("results/tt_overall.pdf", height = 5)



# dat |> 
#   mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", "male and female with group composition not specified", "male and female in separate groups"), "mixed gender groups", participant_sex)) |> 
#   distinct(unique_study_id, .keep_all = T) |> 
#   filter(participant_sex %in% c("mixed gender groups", "only male", "only female")) |> 
#   count(year, participant_sex) |> 
#   add_row(year = 1985, participant_sex = "mixed gender groups") |> 
#   complete(year, participant_sex, fill = list(n = 0)) |> 
#   ggplot(aes(year, n, col = participant_sex)) +
#   geom_line(size = 2) +
#   scale_x_continuous(limits = c(1985, 2018), 
#                      breaks = c(1985, seq(1985, 2020, by = 5), 2018)) +
#   theme_bw() +
#   theme(legend.position="bottom") +
#   labs(x = NULL, y = "# of studies", col = NULL)
  
ggsave("results/tt_participant_sex.pdf")
  
```


Table XX details the number of papers for each study design.
```{r}
dat |> 
  distinct(unique_paper_id, unique_study_id, study_design) |> 
  group_by(study_design) |> 
  summarise(n_papers = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id)) |> 
  kable(format = "latex", booktabs = T)
```

Table XX details the distribution of behavioral outcomes within studies that employ observational designs (i.e., quasi-experimental and observational studies) and randomized designs (i.e., experiments and horse-race experiments). 
```{r}

dat |> 
  filter(scale_type == "behavior") |> 
  distinct(unique_study_id, study_design, behavior_type) |> 
  count(study_design, behavior_type) |> 
  pivot_wider(values_from = n, id_cols = behavior_type, names_from = study_design, values_fill = 0) |> 
  janitor::adorn_totals() |> 
  kable(format = "latex", booktabs = T)
```


We recovered XXX manuscripts and XXX studies from our search that qualified methodologically and theoretically.

```{r}
dat %>% 
  select(unique_study_id, unique_paper_id) %>% 
  summarise(n_papers = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id))
```



### Overview of Studies in the Meta-Analytic Database

```{r }
dat |> 
  select(contains("n_")) |> 
  View()

# average N?
mean(dat$n_t_post) + mean(dat$n_c_post)
mean(dat$n_t_pre, na.rm = T) + mean(dat$n_c_pre, na.rm = T)

# participant sex
table(dat$condition_gender)

## intervention length
mean(dat$intervention_length, na.rm = T)
quantile(dat$intervention_length, probs = seq(0, 1, by = 0.2), na.rm = TRUE)
```

### Meta-Analytic Results

(see 3-sa-meta.Rmd)


We found XX studies that measured self-reported behavior.
```{r}
dat %>% 
  select(unique_study_id, scale_type) %>% 
  group_by(scale_type) %>% 
  summarise(n_unique_studies = n_distinct(unique_study_id)) 
```

XX of these studies measured behavior only in the immediate aftermath of the intervention, while xx included long-term measures.  
```{r}
dat %>% 
  filter(scale_type == "behavior") %>% 
  select(unique_study_id, delay) %>% 
  drop_na(delay) %>% 
  group_by(unique_study_id) %>% 
  mutate(max_delay = max(delay),
         only_short_term = max_delay == 0) %>% 
  count(only_short_term) %>% 
  ungroup() %>% 
  count(only_short_term)
```

To do so, we break down our dataset according to four types of study designs: experimental studies, quasi experimental studies, and observational studies. as presented in Table X, 
```{r}
dat %>% 
  select(unique_study_id, scale_type, study_design, d) %>% 
  filter(scale_type == "behavior") %>% 
  group_by(unique_study_id, study_design) %>% 
  summarise(mean_d_by_study_x_design = mean(d)) %>% 
  group_by(study_design) %>% 
  summarise(n = n(),
            mean_d_by_design = mean(mean_d_by_study_x_design)) %>% 
  kable(digits = 2, format = "latex", booktabs = T) %>%
  kableExtra::kable_styling() 
```

```{r}
dat |> 
  filter(scale_type == "attitudes") |> 
  distinct(unique_study_id, scale_name) |> 
  count(scale_name, sort = T) |> 
  View()
```

how many studies evaluate rape myths?
```{r rape_myth_outcome_prevalence}
dat %>%
  group_by(unique_study_id) %>%
  summarise(
    myth_var = any(str_detect(scale_name, "myth|IRMA|illinois"))
  ) %>%
  summarise(
    myth_count = sum(myth_var),
    no_myth_count = sum(!myth_var)
  )

```

what's the distribution of outcome types for bystander interventions

```{r bystander_dv_count}

# filter based on mentioning bystander in either title, description, 
# intervention name, or program name, or have a stated purpose of "4" (bystander)
bystander_dat <- dat %>%
  filter(
    str_detect(paper_title, "bystander") |
      str_detect(brief_description_of_the_intervention, "bystander") |
      str_detect(intervention_name, "bystander") |
      str_detect(program_name, "bystander") |
      str_detect(stated_purpose, "4"))

bystander_dat %>%  study_count()

table(bystander_dat$behavior_type)    
# now what's the DV count for the studies that remain



## BTW an alternate way to do this
dat %>%
  group_by(unique_study_id) %>%
  summarise(
    bystander_count = ifelse(
      any(
        str_detect(c(
          brief_description_of_the_intervention, 
          intervention_name, program_name, paper_title), "bystander")) |
        any(str_detect(stated_purpose, "4")),
      TRUE, FALSE)
  ) %>% 
  summarise(
    bystander = sum(ifelse(is.na(bystander_count), FALSE, bystander_count)),
    no_bystander = sum(ifelse(is.na(bystander_count), TRUE, !bystander_count))
  )



```