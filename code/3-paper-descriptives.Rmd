---
title: "5-descriptives"
author: "Seth Green and Johh-Henry Pezzuto"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  rmarkdown::html_document:
    smart: true
    theme: spacelab
    number_sections: no
    toc_float:
      collapsed: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---


```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE, 
                      results = 'markup')


library(tidyverse)
library(ggtext)
library(patchwork)
library(ggthemes)
library(ggrepel)
library(knitr) 
library(kableExtra)
library(janitor)
library(scales)
library(metafor)

source('./functions/study_count.R')
source('./functions/map_robust.R')

dat <- readRDS(file = '../data/sa_meta_data_final.rds') |>
  mutate(
    attitudes_behaviors = case_when(
      all(c('attitudes', 'behavior') %in% scale_type) ~ 0,
      scale_type == 'attitudes' ~ 1,
      scale_type == 'behavior' ~ 2)) |>
  ungroup()
```

# The Problem of Sexual Violence

Our present review provides empirical results from 13 countries

```{r}
length(unique(dat$country))
```


## Inclusion and Exclusion Criteria for Study Selection

Table 1 details the number of papers for each study design.

```{r}
dat |> 
  distinct(unique_paper_id, unique_study_id, study_design) |> 
  group_by(study_design) |> 
  summarise(n_papers = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id)) |> 
  kable(format = "latex", booktabs = T)
```


# Overview of the Studies in the Meta-Analytic Database

The database
spans the years 1985-2018, encompassing 226 manuscripts that describe 304 studies, in which we coded 500 distinct point estimates.

```{r years_and_countries}
dat |> 
  summarise(year_min = min(year),
            year_max = max(year),
            n_manuscripts = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id),
            n_point_estimates = n())
```


Overall these are relatively large studies, with an average of 403 participants and a median of 162 participants. 

```{r}
dat |> 
  group_by(unique_study_id) |> 
  summarise(mean_n_per_study = mean(n_t_post, na.rm = T) + mean(n_c_post, na.rm = T)) |>  # collapse outcomes first, so studies with more outcomes don't have more weight
  ungroup() |> 
  summarise(mean_n = mean(mean_n_per_study), # then collapse studies in estimate
            median_n = median(mean_n_per_study))
```



In addition, 30% percent of these studies test primary prevention efforts that span more than one day.

```{r}
dat |>
  distinct(unique_study_id, intervention_length) |> 
  mutate(intervention_length = ifelse(intervention_length > 1, 1, 0)) |> 
  summarise(perc_greater_1_day = mean(intervention_length, na.rm = T))
```


```{r}
tt_overall = dat |> # overall line
      group_by(year) |>
      summarise(n = n_distinct(unique_study_id)) |>
      add_row(year = 1985, n = 0)

zeitgeist = tibble(year = c(1998, 2000, 2007), 
                   n = pull(filter(tt_overall, year %in% c(1998, 2000, 2007)), n),
                   event = c("Safe dates", "Men's Program", "Bringing in\nthe Bystander"))

tt_overall     |>
  ggplot(aes(year, n)) +
  geom_line(size = 2) +
  # geom_segment(aes(x = year, ## add "flag poles"
  #                  xend = year,
  #                  y = 0,
  #                  yend = n,
  #                  label = NULL),
  #              inherit.aes = F, 
  #              linewidth = 1.5,
  #              data = zeitgeist) +
    geom_label_repel(mapping = aes(x = year, ## labels
                                   y = n,
                                   label = event),
                     size = 6,
                     segment.size	= 1.5,
                     inherit.aes = F,
                     data =  zeitgeist,
                     nudge_x = c(2, 2.5, -1.9),
                     nudge_y = c(6, 5.5, 5),
                     min.segment.length = 0, 
                     force = 0.3) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.position = "bottom"
  ) +
  labs(
    x = NULL,
    y = "# of studies",
    col = NULL
  )

ggsave("results/tt_studies.pdf", height = 5)
```

We observe that 270 studies which constitute 89% of the database were conducted in the United States. The remaining 34 studies
come from various places around the world, including Canada, Europe, and Africa.


```{r}
dat |> 
  distinct(unique_study_id, country) |> 
  count(country, sort = T) |> 
  mutate(perc = n / sum(n))
```


Nearly 69% of all studies are conducted among college students. Another 13% focus on high school students, while 9% percent
focus on middle school students. Outside of the education sphere, we find that 4% of studies were conducted
in the workplace, and 2% in community settings. 

```{r}
dat |> 
  distinct(unique_study_id, setting) |> 
  count(setting, sort = T) |> 
  mutate(perc = n / sum(n))
```


In fact, 61% of the studies targeted both men and women, while 27% targeted only men, and 6% targeted only women (1% of studies did not report the gender target).
```{r}
dat |> # 
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", 
                                                             "male and female with group composition not specified", 
                                                             "male and female in separate groups"), 
                                      "mixed gender groups", 
                                      participant_sex)) |>
      distinct(unique_study_id, participant_sex) |>
  count(participant_sex, sort = T) |> 
  mutate(perc = n / sum(n))
```


```{r descriptive_fig}
(country_fig = dat |> 
  distinct(unique_study_id, country) |> 
  mutate(country = ifelse(country == "USA", "USA", "Rest of the world")) |> 
  count(country, sort = T) |> 
  mutate(country = fct_rev(fct_reorder(factor(country), n)),
         perc = n / sum(n)) |>
  ggplot(aes(country, n, label = n, fill = country)) +
  geom_col() +
  theme_bw() +
  theme(axis.text = element_markdown(size = 12), 
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        plot.title = element_markdown()) +
  scale_y_continuous(breaks = seq(0, 300, by = 100), limits = c(0, 300)) +
  scale_fill_manual(values = ggthemes::solarized_pal()(2)) +
  guides(fill = "none") +
  labs(title = "**a)** Number of Studies by Country",
       x = NULL, 
       y = "# of studies", 
       col = NULL))
  
(setting_fig = dat |> 
  distinct(unique_study_id, .keep_all = T) |> 
  count(setting, sort = T) |> 
  drop_na(setting) |> 
  mutate(perc = n / sum(n)) |>
  ggplot(aes(setting, n, fill = setting)) +
  geom_col() +
  scale_fill_manual(values = ggthemes::tableau_color_pal('Tableau 10')(6)) +
  labs(title = "**b)** Number of Studies by Setting",
       x = NULL, 
       y = "# of studies", 
       col = NULL) +
  theme_bw() +
    guides(fill = "none") +
  theme(axis.text = element_markdown(size = 12),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        plot.title = element_markdown()))


dat_participant_sex <- dat |> # participant sex lines
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", 
                                                             "male and female with group composition not specified", 
                                                             "male and female in separate groups"), 
                                      "mixed gender groups", 
                                      participant_sex)) |>
      distinct(unique_study_id, .keep_all = T) |>
      filter(participant_sex %in% c("mixed gender groups", "only male", "only female")) |>
      count(year, participant_sex) |>
      add_row(year = 1985, participant_sex = "mixed gender groups") |>
      complete(year, participant_sex, fill = list(n = 0)) |>
      mutate(participant_sex = str_to_title(participant_sex)) |>
  mutate(participant_sex = factor(participant_sex, levels = c("Mixed Gender Groups", "Only Male", "Only Female")))



(tt_gender_fig = dat_participant_sex |>
  ggplot(aes(year, n, col = participant_sex)) +
  geom_line(size = 2) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::palette_pander(3)) +
  theme_bw() +
  theme(
    axis.text = element_markdown(size = 12), 
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    plot.title = element_markdown(),
    legend.position = "bottom"
  ) +
  labs(
    title = "**c)** Number of Studies Over Time by Group Gender (1985-2018)",
    x = NULL,
    y = "# of studies",
    col = NULL
  ))

country_fig / setting_fig / tt_gender_fig

ggsave("results/descriptive.pdf", width = 7, height = 7)
```


## Zeitgeist Programs

### The first 15 Years

In the first 15 years, we find 110 studies reported in 77 manuscripts (constituting 36% of our database). 
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
  summarise(n_manuscript = n_distinct(unique_paper_id),
            n_studies = n_distinct(unique_study_id))



dat |> 
  mutate(early = between(year, 1985, 2000)) |> 
  distinct(unique_study_id, .keep_all = T) |> 
  summarise(perc_early = mean(early))
```



This is also apparent when looking at the type of publication; while 56 of these studies are journal articles, 54 are dissertations
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_study_id, publication_type) |> 
  count(publication_type)
```



The majority of these studies are laboratory studies (n = 61) as opposed to field studies (n = 49) that encompass the larger programmatic evaluations that dominate the next generation of studies.
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
  distinct(unique_study_id, lab_field, publication_type) |> 
  count(lab_field)
```


These studies tend to be smaller than the next generation of studies (with an average of 188 participants)

```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
  group_by(unique_study_id) |> 
  summarise(mean_n_per_study = mean(n_t_post, na.rm = T) + mean(n_c_post, na.rm = T)) |>  # collapse outcomes first, so studies with more outcomes don't have more weight
  ungroup() |> 
  summarise(mean_n = mean(mean_n_per_study)) # then collapse studies in estimate
```


which constitute 56\% of all studies in this time frame), but a relatively high number of studies that target only men (32 studies, which constitute 29\% of all studies in this time frame).
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |> 
      mutate(participant_sex = ifelse(participant_sex %in% c("male and female in mixed groups", 
                                                             "male and female with group composition not specified", 
                                                             "male and female in separate groups"), 
                                      "mixed gender groups", 
                                      participant_sex)) |>
      distinct(unique_study_id, participant_sex) |>
  count(participant_sex, sort = T) |> 
  mutate(perc = n / sum(n))
```

## Trends in Measurement in the Database

Overall, mentalizing outcomes outnumber behavioral outcomes in our sample by 355 to 145. 
```{r}
dat |> 
  select(scale_type) |> 
  group_by(scale_type) |> 
  summarise(n = n())
```


207 studies measure mentalizing outcomes only; 
```{r}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_attitudes = sum(scale_type == "attitudes") / n()) |> 
  filter(perc_attitudes == 1) |> 
  ungroup() |> 
  nrow()
```


36 measure only behaviors; 
```{r}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_attitudes = sum(scale_type == "attitudes") / n()) |> 
  filter(perc_attitudes == 0) |> 
  ungroup() |> 
  nrow()
```


61 measure both
```{r}
dat |> 
  select(unique_study_id, scale_type) |> 
  group_by(unique_study_id) |> 
  summarise(perc_attitudes = sum(scale_type == "attitudes") / n()) |> 
  filter(!perc_attitudes %in% c(0,1)) |> 
  ungroup() |> 
  nrow()
```


While in the first 15 years, the ratio between mentalizing outcomes and behavior outcomes was
roughly 1 to 4, after 2010 this ratio drops to 1 to 1.5.
```{r}
dat |> 
  filter(between(year, 1985, 2000)) |>
  count(scale_type) |> 
  pivot_wider(names_from = scale_type, values_from = n) |> 
  mutate(ratio = attitudes/behavior)
```

after 2010 [the ratio between mentalizing outcomes and behavior outcomes] drops to 1 to 1.4.
```{r}
dat |> 
  filter(year > 2010) |>
  count(scale_type) |> 
  pivot_wider(names_from = scale_type, values_from = n) |> 
  mutate(ratio = attitudes/behavior)
```


Fig 3 displays the relationship between these outcomes over time.

```{r fig_tt_att_beh}
dat |> 
  mutate(scale_type = str_to_title(ifelse(scale_type == "attitudes", "mentalizing", "behavior"))) |> 
  distinct(year, unique_study_id, scale_type) |> 
  count(year, scale_type) |> 
  add_row(year = 1985, scale_type = "Behavior") |> 
  complete(year, scale_type, fill = list(n = 0)) |> 
  ggplot(aes(x = year, y = n, color = scale_type)) +
  geom_line(size = 3) + 
  labs(
    x = NULL,
    y = "# of studies",
    col = NULL
  ) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::tableau_color_pal('Color Blind')(2)) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12), 
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.position = "bottom"
  )

ggsave("results/tt_att_beh.pdf", height = 5)
```


## Measuring Sexually Violent Behavior

behavioral outcomes that fall into four categories: perpetration, victimization, bystander, and involvement. Figure XX demonstrates the trends over time in these measurements.

```{r}
dat |>
  filter(behavior_type != "Attitude") |> 
  distinct(unique_study_id, year, behavior_type) |> 
  count(year, behavior_type) |> 
  add_row(year = 1985:1990, behavior_type = "Involvement") |> # start at 0 for all behaviors. here i use arbitrary behavior 
  complete(year, behavior_type, fill = list(n = 0)) |> 
  ggplot(aes(x = year, y = n, color = behavior_type)) +
  geom_line(size = 3) + 
  labs(x = NULL, 
       y = "# of studies", 
       col = NULL) +
  scale_x_continuous(
    limits = c(1985, 2018),
    breaks = c(1985, seq(1985, 2020, by = 5), 2018)
  ) +
  scale_color_manual(values = ggthemes::stata_pal("s1color")(4)) +
  theme_bw() +
    theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),    
    legend.position = "bottom",
    legend.box = "vertical"
  )

ggsave("results/tt_beh_type.pdf", height = 5)
```


## Measuring Mentalizing

Overall these and other myth measures constitute 56% of the mentalizing measures we coded
```{r}
dat |> 
  select(scale_name, behavior_type) |> 
  filter(behavior_type == "Attitude") |> 
  mutate(myth_scale = str_detect(str_to_lower(scale_name), "myth")) |> 
  group_by(myth_scale) |> 
  summarise(n = n()) |> 
  mutate(perc = n / sum(n))
```

```{r}
dat |> 
  filter(has_both == 'both') |> 
  drop_na(study_design) |> 
  group_by(author, year, study_design, unique_study_id, scale_type) |>
  summarise(mean_d = mean(d), 
         mean_var_d = mean(var_d), 
         mean_se_d = mean(se_d)) |> 
  pivot_wider(id_cols = c(author, year, unique_study_id, study_design),
    names_from = c(scale_type), 
    values_from = c(mean_d, mean_var_d, mean_se_d)) |>
  ggplot(aes(x = mean_d_attitudes,
             y = mean_d_behavior)) + 
  geom_point(aes(color = study_design),
             size = 3) + 
  geom_abline(slope = 1, 
              lty = 'dashed',
              size = 2) +
  geom_smooth(lty = "dashed", 
              method = "lm", 
              se = FALSE,
              color = 'grey',
              size = 2) +  
  scale_x_continuous(breaks = seq(-.5, 1.5, by = .5), limits = c(-.5,1.6)) +
  scale_y_continuous(breaks = seq(-.5, 1.5, by = .5), limits = c(-.5,1.6)) +
  scale_color_manual(values = ggthemes::stata_pal("s2color")(3)) +
  labs(x = "Effect size (Mentalizing)",
       y = "Effect size (Behaviors)",
       color = NULL) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.position = "bottom",
    legend.box = "vertical"
  )

ggsave("results/att_beh_corr.pdf", width = 7.2, height = 7.2)
```